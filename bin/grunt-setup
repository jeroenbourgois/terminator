#!/usr/bin/env bash

wget -N --quiet https://raw.github.com/pierot/server-installer/master/lib.sh; . ./lib.sh

_print_h1 "Grunt setup"

###############################################################################

# check if input is coming from a pipe
if [[ -p /dev/stdin ]] ; then
  IFS=$'\n' read -d '' -r -a target_dir
else
  if [ -z "$1" ]; then
    target_dir='.'

    _print_h2 "No target given, exporting to ."
  fi
fi

if [ -z "$target_dir" ]; then
  target_dir=$1
fi

_print_h2 "Exporting to ./$target_dir"

###############################################################################

tmp_dir=$target_dir/grunt_tmp
mkdir -p $tmp_dir

###############################################################################

_print_h2 "Cloning repo"

git clone -q git@github.com:proximitybbdo/grunt-compile-bootstrap.git $tmp_dir

_print_h2 "Copying all necessary files"

targets=(Gruntfile.coffee config.rb package.json)

for i in "${targets[@]}"; do
  cp $tmp_dir/$i $target_dir/$i
done

rm -rf $tmp_dir

_print_h2 "Setting up assets directories"

targets=('*.js' 'vendor/*.min.js' 'lib/*.min.js' 'css/*.css' 'css/vendor/*.css')

for i in "${targets[@]}"; do
  rm -f $target_dir/assets/$i
done

# COFFEESCRIPT
mkdir -p $target_dir/assets/coffee

_print_h2 "Init node modules"

echo "\nnode_modules" >> $target_dir/.gitignore

cd $target_dir
npm install -q

_print_h2 "Done"
